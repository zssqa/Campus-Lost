<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布信息 - 校园失物招领平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">校园失物招领平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/posts">失物招领信息</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/login">登录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/register">注册</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="form-page fade-in">
                    <div class="text-center mb-4">
                        <h2 class="page-title">发布失物/拾到信息</h2>
                        <p class="text-muted">请填写以下信息来发布您的失物或拾到信息</p>
                    </div>
                    <form id="postForm">
                        <div class="mb-4">
                            <label class="form-label">信息类型 *</label>
                            <div class="d-flex gap-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="type" id="lostType" value="LOST" checked>
                                    <label class="form-check-label" for="lostType">丢失</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="type" id="foundType" value="FOUND">
                                    <label class="form-check-label" for="foundType">拾到</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="title" class="form-label">标题 *</label>
                            <input type="text" class="form-control" id="title" name="title" placeholder="请输入标题" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="categoryId" class="form-label">分类 *</label>
                            <select class="form-select" id="categoryId" name="categoryId" required>
                                <option value="">请选择分类</option>
                                <option value="1">证件</option>
                                <option value="2">电子产品</option>
                                <option value="3">钥匙</option>
                                <option value="4">书籍</option>
                                <option value="5">衣物</option>
                                <option value="6">其他</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="content" class="form-label">详细描述 *</label>
                            <textarea class="form-control" id="content" name="content" rows="5" placeholder="请详细描述物品信息、丢失/拾到情况等" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="happenTime" class="form-label">发生时间 *</label>
                            <input type="datetime-local" class="form-control" id="happenTime" name="happenTime" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="locationText" class="form-label">地点 *</label>
                            <input type="text" class="form-control" id="locationText" name="locationText" placeholder="请输入丢失/拾到地点" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tags" class="form-label">标签</label>
                            <input type="text" class="form-control" id="tags" name="tags" placeholder="多个标签用逗号分隔，如：手机,苹果,丢失">
                            <div class="form-text">示例：手机,苹果,丢失</div>
                        </div>
                        
                        <div class="mb-4 form-check">
                            <input type="checkbox" class="form-check-input" id="anonymous">
                            <label class="form-check-label" for="anonymous">匿名发布</label>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end btn-group-spacing">
                            <a href="/posts" class="btn btn-secondary">取消</a>
                            <button type="submit" class="btn btn-primary">
                                <span id="submitText">发布信息</span>
                                <span id="loadingSpinner" class="loading d-none"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer mt-5 py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">© 2025 校园失物招领平台</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 导航栏登录态切换
        function updateNavbar() {
            const userJson = sessionStorage.getItem('currentUser');
            const navRight = document.querySelector('.navbar .navbar-nav:last-child');
            if (!navRight) return;
            if (userJson) {
                const user = JSON.parse(userJson);
                navRight.innerHTML = '';
                const li = document.createElement('li');
                li.className = 'nav-item dropdown';
                li.innerHTML = '<a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">' + (user.nickname || user.account || '已登录') + '</a>' +
                               '<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">' +
                               '<li><a class="dropdown-item" href="/post/create">发布信息</a></li>' +
                               '<li><hr class="dropdown-divider"></li>' +
                               '<li><a class="dropdown-item" href="#" id="logoutLink">退出登录</a></li>' +
                               '</ul>';
                navRight.appendChild(li);
                setTimeout(function(){ var el = document.getElementById('logoutLink'); if (el) el.addEventListener('click', function(e){ e.preventDefault(); sessionStorage.removeItem('currentUser'); window.location.href = '/'; }); }, 0);
            }
        }
        // 设置默认时间为当前时间
        window.onload = function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const dateTimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('happenTime').value = dateTimeLocal;
        };

        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // 获取表单数据
            const title = document.getElementById('title').value;
            const categoryId = document.getElementById('categoryId').value;
            const content = document.getElementById('content').value;
            const happenTime = document.getElementById('happenTime').value;
            const locationText = document.getElementById('locationText').value;
            
            // 表单验证
            if (!title.trim() || !categoryId || !content.trim() || !happenTime || !locationText.trim()) {
                alert('请填写所有必填信息');
                return;
            }
            
            // 显示加载状态
            submitText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            document.querySelector('button[type="submit"]').disabled = true;
            
            // 获取表单数据
            const formData = new FormData(this);
            const data = {};
            
            // 转换FormData为普通对象
            for (let [key, value] of formData.entries()) {
                if (key === 'happenTime') {
                    // 将日期时间转换为时间戳
                    data[key] = new Date(value).getTime();
                } else {
                    data[key] = value;
                }
            }
            
            // 添加匿名字段
            data.anonymous = document.getElementById('anonymous').checked;
            
            // 发布信息请求
            fetch('/api/user/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.code === 200) {
                    alert('信息发布成功！');
                    // 跳转到信息列表页面
                    window.location.href = '/posts';
                } else {
                    alert('发布失败：' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('发布过程中发生错误');
            })
            .finally(() => {
                // 恢复按钮状态
                submitText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
                document.querySelector('button[type="submit"]').disabled = false;
            });
        });
        
        // 页面加载动画
        document.addEventListener('DOMContentLoaded', function() {
            updateNavbar();
            const formPage = document.querySelector('.form-page');
            formPage.style.opacity = '1';
            formPage.style.transform = 'translateY(0)';
        });
        
        // 实时字符计数
        document.getElementById('content').addEventListener('input', function() {
            const maxLength = 500;
            const currentLength = this.value.length;
            if (currentLength > maxLength) {
                this.value = this.value.substring(0, maxLength);
            }
        });
    </script>
</body>
</html>